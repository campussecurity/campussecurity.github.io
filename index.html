<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
	<title>CS171 Final Project</title>
	<!-- Common CSS/JSS are incorporated into bootstrap.min.css -->
	<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
	<link rel="stylesheet" href="css/campusSecurity.css" type="text/css">
	<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>										
</head>

<body>
	<div class="container">	
		<!--row1: Site Name-->
		<header class="row " >
		</header>
				
		<!--row2: navigation -->
		<nav class=" row navbar navbar-default " role="navigation">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
				    <span class="sr-only">Toggle navigation</span>
				    <span class="icon-bar"></span>
				    <span class="icon-bar"></span>
				    <span class="icon-bar"></span>
				</button>
			</div>
			<div class="collapse navbar-collapse" id="collapse">
				<ul class="nav navbar-nav">
					<li><a href='index.html'>Home</a></li>
					<li><a href='http://github.com/campussecurity/campussecurity.github.io'>Code Source</a></li>
					<li><a href='/doc/PressBook.md'>PressBook</a></li>
				</ul>
			</div>
		</nav>
		<div class="row panel-info-darken edge-height">
			<main class="col-md-8 col-sm-12  panel-info-darken" >				
				<div class="col-md-12 col-sm-12 panel panel-info">	
					<div class="col-md-6 col-sm-6 panel-calm main-top" id="map-control-1">
						<h2>Map Control Panel 1</h2>

					</div>
					<div class="col-md-3 col-sm-3 panel-calm main-top" id="map-control-2">	
						<h2>Map Control Panel 2</h2>
					</div>
					<div class="col-md-3 col-sm-3 panel-calm main-top" id="map-control-3">	
						<h2>Map Control Panel 3</h2>
					</div>
					<div class="col-md-12 col-sm-12 panel-calm main-center" id="map">	
				
					</div>					
				</div>							
			</main>

			<aside class="col-md-4 col-sm-12 panel-info-darken">								
				<div class="col-md-12 col-sm-7 panel panel-info aside-center" id="box1">
                    <div>Murder:</div><input class="weightScale" id="murdId" type="number" min="0" max="100" value="0"
                                             step="10" onchange="refreshData()">
                    <div>Neg:</div><input class="weightScale" id="negId" type="number" min="0" max="100" value="100"
                                          step="10" onchange="refreshData()">
                    <div>Forcib:</div><input class="weightScale" id="forcibId" type="number" min="0" max="100"
                                             value="10" step="10" onchange="refreshData()">
                    <div>Non-Forcib:</div><input class="weightScale" id="nonForcibId" type="number" min="0" max="100"
                                                 value="10" step="10" onchange="refreshData()">
                    <div>Robbe:</div><input class="weightScale" id="robbeId" type="number" min="0" max="100"  value="20"
                                            step="10" onchange="refreshData()">
                    <div>Burg:</div><input class="weightScale" id="burgId" type="number" min="0" max="100"  value="25"
                                           step="10" onchange="refreshData()">
                    <div>Vehic:</div><input class="weightScale" id="vehicId" type="number" min="0" max="100"
                                            value="100" step="10" onchange="refreshData()">
				</div>
				<div class="col-md-12 col-sm-5 panel panel-info aside-top" id="box2">
					<h1>box2</h1>
				</div>
				<div class="col-md-12  col-sm-5 panel panel-info aside-bottom" id="video">
					<h1>Video</h1>
				</div>				
		 	</aside>
		 	<section class="col-md-12 col-sm-12 panel-info-darken">
		 		<div class="col-md-12  panel panel-info aside-bottom" id="box3">
					<h1>box3</h1>
				</div>
		 	</section>
		</div>
			
		<footer class="edge-width">
			<a href="home.html">Home</a>|<a href="">About</a>|<a href=''>Contact</a>|
		</footer>
	</div> 
	<script type="text/javascript">

    var txt;



      // get the width of a D3 element
    var w = $("#map").width();
    var mapRatio = 0.6;
    var h = w*mapRatio;

    var xOffset = 0, yOffset =0, scale =1.3* w;

    var projection = d3.geo.albersUsa()
            .translate([w/2, h/2]).scale([1.3*w]);

    var drag = d3.behavior.drag()
            .on("drag", dragMove);

    var universityAggregateData =null;
    var cityDataSave  = null;
    var path = d3.geo.path().projection(projection);
    var paths = null;
    var svg = d3.select("#map")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

    svg.call(d3.behavior.zoom().scaleExtent([1, 1.3*w]).on("zoom", zoom));
    svg.call(drag);
    $( window ).resize(function() {
        svg.call(resize);
    });

    var colors = d3.scale.category20();
    loadData();
    var multiplier = 10000;

    function getWeights(){
        var murdFactor = parseInt($("#murdId").val());
        var negligenceFactor = parseInt($("#negId").val());
        var forcibleCrimeFactor = parseInt($("#forcibId").val());
        var nonForcibleCrimeFactor = parseInt($("#nonForcibId").val());
        var robberyCrimeFactor = parseInt($("#robbeId").val());
        var burglaryCrimeFactor = parseInt($("#murdId").val());
        var vehicleCrimeFactor = parseInt($("#vehicId").val());


        return {
            murdFactor:murdFactor,
            negligenceFactor:negligenceFactor,
            forcibleCrimeFactor:forcibleCrimeFactor,
            nonForcibleCrimeFactor:nonForcibleCrimeFactor,
            robberyCrimeFactor:robberyCrimeFactor,
            burglaryCrimeFactor:burglaryCrimeFactor,
            vehicleCrimeFactor:vehicleCrimeFactor
        }
    }

    function getAveCrimeFactor(univAggrData,weights){

        return weights.murdFactor * univAggrData.totMurd +
                weights.negligenceFactor * univAggrData.totNegM +
                weights.forcibleCrimeFactor * univAggrData.totForcib +
                weights.nonForcibleCrimeFactor * univAggrData.totNonForcib +
                weights.robberyCrimeFactor * univAggrData.totRobbe +
                weights.burglaryCrimeFactor * univAggrData.totBurgla +
                weights.vehicleCrimeFactor * univAggrData.totVehic;
    }

    function processCrimeFactor(cityData,weights){
        var minCrimeFactor = null, maxCrimeFactor = null;

        cityData.forEach(function(d){
            var crimeFactor = multiplier * weights.murdFactor * d.Murder +
                    multiplier * weights.negligenceFactor * d.NegM +
                    multiplier * weights.forcibleCrimeFactor * d.Forcib +
                    multiplier * weights.nonForcibleCrimeFactor * d.NonForcib +
                    multiplier * weights.robberyCrimeFactor * d.Robbe +
                    multiplier * weights.burglaryCrimeFactor * d.Burgla +
                    multiplier * weights.vehicleCrimeFactor * d.Vehic;
            d["crimeFactor"] = crimeFactor;

            if (minCrimeFactor == null){
                minCrimeFactor = crimeFactor;
            }
            else if(minCrimeFactor > crimeFactor){
                minCrimeFactor = crimeFactor;
            }

            if(maxCrimeFactor == null){
                maxCrimeFactor = crimeFactor;
            }
            else if(maxCrimeFactor<crimeFactor){
                maxCrimeFactor = crimeFactor;
            }
        })

        return{
            minCrimeFactor: minCrimeFactor,
            maxCrimeFactor: maxCrimeFactor
        }

    }

    function paintCircles(aveCrimeFactor,maxCrimeFactor,cityData){
        var colorScale = d3.scale.linear().domain
        ([aveCrimeFactor, maxCrimeFactor]).range(["#8b0000", "#FFF0F0"])

        svg.selectAll("circle").remove();
        svg.selectAll("circle")
                .data(cityData)
                .enter()
                .append("circle")
                .attr("city", function(d){return d.City})
                .attr("cx", function(d) {
                    var proj = projection([d.Longitude, d.Latitude]);
                    if(!proj){
                        console.log("Invalid lat /long",d);
                        return null;
                    }
                    else {
                        return projection([d.Longitude, d.Latitude])[0];
                    }

                })
                .attr("cy", function(d) {
                    var proj = projection([d.Longitude, d.Latitude]);
                    if(!proj){
                        console.log("Invalid lat /long",d);
                        return null;
                    }
                    else {
                        return proj[1];
                    }
                })
                .attr("r",function(d,i){
                    if (d.crimeFactor > aveCrimeFactor){
                        return 3
                    }
                    else {
                        return 1.5
                    }
                })
                .style("fill", function(d,i){

                    if (d.crimeFactor > aveCrimeFactor){
                        return colorScale(d.crimeFactor)
                    }
                    else {
                        return "green"
                    }


                })
                .style("opacity", function(d){
                    if (d.crimeFactor > aveCrimeFactor){
                        return 1
                    }
                    else {
                        return .3
                    }
                })
                .on('mouseover',showCityData)

        svg.selectAll("txt").remove();
        txt = svg.append("text")
                .style("visibility", "hidden")
                .attr("class","schoolLabel")
    }

    function refreshData(){
        var weights = getWeights();
        var aveCrimeFactor= getAveCrimeFactor(universityAggregateData,weights)
        var minCrimeFactor = null, maxCrimeFactor = null;
        var crimeFactors = processCrimeFactor(cityDataSave,weights);
        minCrimeFactor = crimeFactors.minCrimeFactor;
        maxCrimeFactor = crimeFactors.maxCrimeFactor;
        paintCircles(aveCrimeFactor,maxCrimeFactor,cityDataSave);
    }

    function loadData(){


        d3.json("data/us-states.json", function(json) {
            d3.tsv("data/univDataAgg.tsv", function(err,univAggrDataArray){
                var weights = getWeights();
                universityAggregateData = univAggrDataArray[0];

                var aveCrimeFactor= getAveCrimeFactor(universityAggregateData,weights)
                var minCrimeFactor = null, maxCrimeFactor = null;
                d3.tsv("data/univData.tsv", function (err,cityData) {
                    cityDataSave = cityData;
                    var crimeFactors = processCrimeFactor(cityDataSave,weights);
                    minCrimeFactor = crimeFactors.minCrimeFactor;
                    maxCrimeFactor = crimeFactors.maxCrimeFactor;

                    var selectedData = []
                    json.features.forEach(function(d){
                        selectedData.push(d);
                    })

                    //Bind data and create one path per GeoJSON feature
                    paths = svg.selectAll("path")
                            .data(selectedData)
                            .enter()
                            .append("path")
                            .attr("i",function(d,i){return i })
                            .style("fill","#f2f2f2") // function(d, i) {return colors(i)})
                            .style("stroke", "grey")
                            .attr("d", path)
                            .on("mouseover", stateIn)
                            .on("mouseout", stateOut)


                    //Murder	NegM	Forcib	NonForcib	Robbe	AggA	Burgla	Vehic	Arson

                    paintCircles(aveCrimeFactor,maxCrimeFactor,cityDataSave);

                });
            });
        });
    }




    //for counties data, see view-source:http://upload.wikimedia.org/wikipedia/commons/5/59/Usa_counties_large.svg

    //Load in GeoJSON data


    function showCityData(){
        var circle = d3.select(this);

        txt.style("visibility", "visible")
                .transition()
                .delay(100)
                .text(circle.attr("city"))
                .attr("x", circle.attr("cx")+5)
                .attr("y", circle.attr("cy") +5)

    }

    function moveMap(scaleIn){
        //txt.style("visibility", "hidden")
        zoomTimer = null;
        moveTimer = null;


        projection.scale([scale])
                .translate([w/2 + parseInt(xOffset) ,h/2 + parseInt(yOffset)]);
        path.projection(projection)
        paths.attr("d",path)

        svg.selectAll("circle")
                .attr("cx", function(d) {

                    var proj = projection([d.Longitude, d.Latitude]);
                    if(!proj){
                        return null;
                    }
                    else {
                        return projection([d.Longitude, d.Latitude])[0];
                    }

                })
                .attr("cy", function(d) {
                    var proj = projection([d.Longitude, d.Latitude]);
                    if(!proj){
                        return null;
                    }
                    else {
                        return projection([d.Longitude, d.Latitude])[1];
                    }
                })

    }

    var zoomTimer = null;
    var moveTimer = null;

    function zoom(){

        if(zoomTimer){
            clearTimeout(zoomTimer);
        }

        scale =   parseFloat(d3.event.scale)*w;

        zoomTimer = setTimeout(moveMap(scale), 250);
    }

    function dragMove(){

        xOffset += parseFloat(d3.event.dx);
        yOffset += parseFloat(d3.event.dy);

        if(moveTimer){
            clearTimeout(moveTimer);
        }

        moveTimer = setTimeout(moveMap(scale), 250);
    }

    function stateIn(){
        d3.select(this).style("opacity",".6");
    }

    function stateOut(){
        var ctrl = d3.select(this);
        var i=ctrl.attr("i");
        d3.select(this).style("opacity","1");
    }
    function resize(){

        // get the width of a D3 element
        w = $("#map").width();
        h = w*mapRatio;
        scale =1.3* w;
        svg.attr("width", w)
            .attr("height", h);
        moveMap();
    }
	
</script>
</body>
</html>